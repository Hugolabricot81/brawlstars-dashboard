<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brawl Stars - Dashboard Clubs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6C5CE7;
            --secondary: #00B4D8;
            --dark: #1A1A2E;
            --darker: #0F0F1E;
            --light: #FFFFFF;
            --accent: #FF6B9D;
            --success: #00D9A3;
            --card-bg: #252540;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 40px 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 10px 40px rgba(108, 92, 231, 0.3);
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.5em;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff4444;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .clubs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .club-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .club-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(108, 92, 231, 0.4);
            border-color: var(--primary);
        }

        .club-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .club-name {
            font-size: 1.8em;
            font-weight: bold;
            text-transform: capitalize;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .club-icon {
            font-size: 2.5em;
        }

        .club-description {
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 15px;
            font-style: italic;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            opacity: 0.7;
        }

        .stat-value {
            font-weight: bold;
            color: var(--success);
        }

        .top-player {
            background: rgba(108, 92, 231, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--primary);
        }

        .top-player-label {
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .top-player-name {
            font-size: 1.2em;
            font-weight: bold;
        }

        .top-player-trophies {
            color: var(--accent);
            font-size: 1.1em;
        }

        .club-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
            background: rgba(0, 180, 216, 0.2);
            border: 1px solid var(--secondary);
        }

        /* Page d√©taill√©e du club */
        .back-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: var(--secondary);
        }

        .members-list {
            display: grid;
            gap: 15px;
            margin-top: 30px;
        }

        .member-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary);
            transition: transform 0.2s;
        }

        .member-card:hover {
            transform: translateX(5px);
        }

        .member-rank {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent);
            width: 50px;
        }

        .member-info {
            flex: 1;
            margin-left: 20px;
        }

        .member-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .member-role {
            font-size: 0.85em;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .member-stats {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .trophy-count {
            color: var(--success);
            font-size: 1.3em;
            font-weight: bold;
        }

        .ranked-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .clubs-grid {
                grid-template-columns: 1fr;
            }

            .member-stats {
                flex-direction: column;
                gap: 5px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèÜ Brawl Stars Dashboard</h1>
            <p class="subtitle">Statistiques des 6 Clubs</p>
        </header>

        <div id="app">
            <div class="loading">
                <div class="spinner"></div>
                <p>Chargement des donn√©es...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const API_KEY = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiIsImtpZCI6IjI4YTMxOGY3LTAwMDAtYTFlYi03ZmExLTJjNzQzM2M2Y2NhNSJ9.eyJpc3MiOiJzdXBlcmNlbGwiLCJhdWQiOiJzdXBlcmNlbGw6Z2FtZWFwaSIsImp0aSI6IjM3MDJjZWM3LWY0ZjItNGQwYS1hYWZiLWQxOTQ4MjE4OWJkYyIsImlhdCI6MTc2NTM4ODgyNSwic3ViIjoiZGV2ZWxvcGVyL2ZiNDViNGRlLTE5YmUtNTY0Ny01MjUxLTZmYThmNGIxYTg2MiIsInNjb3BlcyI6WyJicmF3bHN0YXJzIl0sImxpbWl0cyI6W3sidGllciI6ImRldmVsb3Blci9zaWx2ZXIiLCJ0eXBlIjoidGhyb3R0bGluZyJ9LHsiY2lkcnMiOlsiMTg1LjE5OS4xMDguMTUzIiwiMTg1LjE5OS4xMDkuMTUzIiwiMTg1LjE5OS4xMTAuMTUzIiwiMTg1LjE5OS4xMTEuMTUzIl0sInR5cGUiOiJjbGllbnQifV19.CFNe-gd1b3m-XP54SC59JXb7TNNAVjjuTxfwJlt1rNMjOSdLyVhRy8F2hgl0IJoJQQP_g9DgjLW29YAEfl8YUA';
        const API_BASE_URL = 'https://api.brawlstars.com/v1';
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // IDs des clubs (tags)
        const CLUBS_DATA = {
            etoilee: '29UPLG8QQ',
            fleurie: '2C9Y28JPP',
            celeste: '2JUVYQ0YV',
            brulee: '2YGPRQYCC',
            gelee: '2CJJLLUQ9',
            mini: '2GVRPPUCY' // √Ä remplacer par le vrai tag du club mini
        };

        const CLUB_ICONS = {
            fleurie: 'üå∏',
            celeste: '‚òÅÔ∏è',
            etoilee: '‚≠ê',
            brulee: 'üî•',
            gelee: 'üßä',
            mini: 'üê£'
        };

        // Traduction des r√¥les
        const ROLE_TRANSLATIONS = {
            'president': 'Pr√©sident',
            'vicePresident': 'Vice-Pr√©sident',
            'senior': 'Ain√©',
            'member': 'Membre'
        };

        // ============================================
        // GESTION DU CACHE
        // ============================================
        class CacheManager {
            static get(key) {
                const cached = localStorage.getItem(key);
                if (!cached) return null;
                
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp > CACHE_DURATION) {
                    localStorage.removeItem(key);
                    return null;
                }
                return data;
            }

            static set(key, data) {
                const cacheData = {
                    data,
                    timestamp: Date.now()
                };
                localStorage.setItem(key, JSON.stringify(cacheData));
            }
        }

        // ============================================
        // API BRAWL STARS
        // ============================================
        class BrawlStarsAPI {
            /**
             * R√©cup√®re les informations compl√®tes d'un club via l'API
             */
            static async fetchClub(clubTag) {
                // Nettoyer le tag (enlever # si pr√©sent)
                const cleanTag = clubTag.replace('#', '');
                const cacheKey = `club_${cleanTag}`;
                
                // V√©rifier le cache
                const cached = CacheManager.get(cacheKey);
                if (cached) {
                    console.log(`‚úÖ Donn√©es du club #${cleanTag} charg√©es depuis le cache`);
                    return cached;
                }

                try {
                    console.log(`üîÑ R√©cup√©ration du club #${cleanTag} depuis l'API...`);
                    const response = await fetch(`${API_BASE_URL}/clubs/%23${cleanTag}`, {
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur API: ${response.status} - ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log(`‚úÖ Club #${cleanTag} r√©cup√©r√©:`, data.name);
                    
                    CacheManager.set(cacheKey, data);
                    return data;
                } catch (error) {
                    console.error(`‚ùå Erreur lors de la r√©cup√©ration du club #${cleanTag}:`, error);
                    return null;
                }
            }

            /**
             * Transforme les donn√©es brutes de l'API en format exploitable
             */
            static formatClubData(clubName, apiData) {
                if (!apiData || !apiData.members) {
                    return null;
                }

                // Trier les membres par troph√©es (du plus haut au plus bas)
                const sortedMembers = apiData.members
                    .map(member => ({
                        name: member.name,
                        tag: member.tag,
                        trophies: member.trophies,
                        role: ROLE_TRANSLATIONS[member.role] || member.role,
                        nameColor: member.nameColor || '#FFFFFF'
                    }))
                    .sort((a, b) => b.trophies - a.trophies);

                const totalTrophies = sortedMembers.reduce((sum, m) => sum + m.trophies, 0);
                const memberCount = sortedMembers.length;

                return {
                    name: clubName,
                    icon: CLUB_ICONS[clubName],
                    tag: apiData.tag,
                    description: apiData.description || '',
                    type: apiData.type,
                    badgeId: apiData.badgeId,
                    requiredTrophies: apiData.requiredTrophies || 0,
                    members: sortedMembers,
                    totalTrophies: totalTrophies,
                    memberCount: memberCount,
                    averageTrophies: memberCount > 0 ? Math.round(totalTrophies / memberCount) : 0,
                    topPlayer: sortedMembers[0] || null
                };
            }
        }

        // ============================================
        // AFFICHAGE DASHBOARD
        // ============================================
        class Dashboard {
            static async render() {
                const app = document.getElementById('app');
                app.innerHTML = '<div class="loading"><div class="spinner"></div><p>Chargement des clubs depuis l\'API Brawl Stars...</p></div>';

                try {
                    // R√©cup√©rer tous les clubs en parall√®le
                    const clubsPromises = Object.entries(CLUBS_DATA).map(async ([name, tag]) => {
                        const apiData = await BrawlStarsAPI.fetchClub(tag);
                        return BrawlStarsAPI.formatClubData(name, apiData);
                    });

                    const clubs = await Promise.all(clubsPromises);
                    
                    // Filtrer les clubs qui n'ont pas pu √™tre charg√©s
                    const validClubs = clubs.filter(club => club !== null);

                    if (validClubs.length === 0) {
                        throw new Error('Aucun club n\'a pu √™tre charg√©');
                    }

                    app.innerHTML = '<div class="clubs-grid" id="clubsGrid"></div>';
                    const grid = document.getElementById('clubsGrid');

                    validClubs.forEach(club => {
                        const card = this.createClubCard(club);
                        grid.appendChild(card);
                    });

                    console.log(`‚úÖ ${validClubs.length} clubs charg√©s avec succ√®s`);

                } catch (error) {
                    console.error('‚ùå Erreur critique:', error);
                    app.innerHTML = `
                        <div class="error">
                            <h2>‚ùå Erreur de chargement</h2>
                            <p>${error.message}</p>
                            <p style="margin-top: 10px; font-size: 0.9em;">V√©rifiez la console pour plus de d√©tails.</p>
                        </div>
                    `;
                }
            }

            static createClubCard(club) {
                const card = document.createElement('div');
                card.className = 'club-card';
                card.onclick = () => ClubDetailView.render(club);

                card.innerHTML = `
                    <div class="club-header">
                        <div>
                            <div class="club-name">${club.name}</div>
                            ${club.description ? `<div class="club-description">"${club.description}"</div>` : ''}
                        </div>
                        <div class="club-icon">${club.icon}</div>
                    </div>
                    
                    <div class="stat-row">
                        <span class="stat-label">Troph√©es totaux</span>
                        <span class="stat-value">üèÜ ${club.totalTrophies.toLocaleString()}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Membres</span>
                        <span class="stat-value">üë• ${club.memberCount}/30</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Moyenne</span>
                        <span class="stat-value">üìä ${club.averageTrophies.toLocaleString()}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Troph√©es requis</span>
                        <span class="stat-value">üéØ ${club.requiredTrophies.toLocaleString()}</span>
                    </div>
                    
                    ${club.topPlayer ? `
                        <div class="top-player">
                            <div class="top-player-label">ü•á Meilleur joueur</div>
                            <div class="top-player-name">${club.topPlayer.name}</div>
                            <div class="top-player-trophies">üèÜ ${club.topPlayer.trophies.toLocaleString()}</div>
                        </div>
                    ` : ''}
                    
                    <div class="club-badge">Tag: ${club.tag}</div>
                `;

                return card;
            }
        }

        // ============================================
        // VUE D√âTAILL√âE DU CLUB
        // ============================================
        class ClubDetailView {
            static render(club) {
                const app = document.getElementById('app');
                
                app.innerHTML = `
                    <button class="back-button" onclick="Dashboard.render()">‚¨Ö Retour au Dashboard</button>
                    
                    <header>
                        <h1>${club.icon} ${club.name.toUpperCase()}</h1>
                        <p class="subtitle">${club.memberCount}/30 membres ‚Ä¢ ${club.totalTrophies.toLocaleString()} troph√©es</p>
                        ${club.description ? `<p class="subtitle" style="margin-top: 10px; font-style: italic;">"${club.description}"</p>` : ''}
                    </header>

                    <div class="chart-container">
                        <canvas id="trophiesChart"></canvas>
                    </div>

                    <div class="members-list" id="membersList"></div>
                `;

                this.renderMembersList(club.members);
                this.renderChart(club.members);
            }

            static renderMembersList(members) {
                const list = document.getElementById('membersList');
                
                members.forEach((member, index) => {
                    const card = document.createElement('div');
                    card.className = 'member-card';
                    
                    // M√©dailles pour le top 3
                    let rankEmoji = `#${index + 1}`;
                    if (index === 0) rankEmoji = 'ü•á';
                    else if (index === 1) rankEmoji = 'ü•à';
                    else if (index === 2) rankEmoji = 'ü•â';
                    
                    card.innerHTML = `
                        <div class="member-rank">${rankEmoji}</div>
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-role">${member.role}</div>
                            <div class="member-stats">
                                <span class="trophy-count">üèÜ ${member.trophies.toLocaleString()}</span>
                                <span class="ranked-badge">${member.tag}</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
            }

            static renderChart(members) {
                const ctx = document.getElementById('trophiesChart').getContext('2d');
                
                // Limiter √† 15 joueurs max pour la lisibilit√© du graphique
                const displayMembers = members.slice(0, 15);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: displayMembers.map(m => m.name),
                        datasets: [{
                            label: 'Troph√©es',
                            data: displayMembers.map(m => m.trophies),
                            backgroundColor: 'rgba(108, 92, 231, 0.6)',
                            borderColor: 'rgba(108, 92, 231, 1)',
                            borderWidth: 2,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: members.length > 15 ? 'Top 15 membres par troph√©es' : 'Troph√©es par membre',
                                color: '#fff',
                                font: { size: 18 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { 
                                    color: '#fff',
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { 
                                    color: '#fff',
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ D√©marrage du Brawl Stars Dashboard...');
            Dashboard.render();
        });
    </script>
</body>
</html>
